<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="#JulyOT RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="#JulyOT Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4LCHFKPDVJ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4LCHFKPDVJ",{anonymize_ip:!0})</script>



<script>!function(t,e,n,c,a,s,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/chk0ns2za1",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,r)}(window,document,"clarity","script")</script><title data-rh="true">12 posts tagged with &quot;embeddediot&quot; | #JulyOT</title><meta data-rh="true" property="og:image" content="https://JulyOT.dev/img/png/julyot-card.png"><meta data-rh="true" property="og:url" content="https://JulyOT.dev/blog/tags/embeddediot/page/3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="msvalidate.01" content="7EBB3CA4C71A21C77534F4358EAE87A2"><meta data-rh="true" name="keywords" content="iot, internet of things, julyot, ai, embedded"><meta data-rh="true" property="og:title" content="12 posts tagged with &quot;embeddediot&quot; | #JulyOT"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="twitter:url" content="https://julyot.dev/blog/22-nano-framework"><meta data-rh="true" name="twitter:title" content="Building .NET nanoFramework and interoperability"><meta data-rh="true" name="twitter:description" content="Building .NET nanoFramework and interoperability"><meta data-rh="true" name="twitter:image" content="https://julyot.dev/img/png/JulyOT-banner-22-nanoframework.png"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="twitter:creator" content="@Jose_Simoes"><meta data-rh="true" name="twitter:site" content="@AzureAdvocates"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="alternate" href="https://JulyOT.dev/blog/tags/embeddediot/page/3" hreflang="en"><link data-rh="true" rel="alternate" href="https://JulyOT.dev/blog/tags/embeddediot/page/3" hreflang="x-default"><link data-rh="true" rel="canonical" href="https://julyot.dev/blog/22-nano-framework"><link rel="stylesheet" href="/assets/css/styles.bbcf359b.css">
<link rel="preload" href="/assets/js/runtime~main.a74aaf32.js" as="script">
<link rel="preload" href="/assets/js/main.e393e4c5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#0D1E4E;color:#7EE2FB" role="banner"><div class="announcementBarContent_xLdY"><b>Join the <a href="https://docs.microsoft.com/learn/challenges?id=261fd583-fa7b-4b1f-86eb-6a52b5468a23&wt.mc_id=eventspg_16482_webpage_reactor" target="_blank"><b>IoT Cloud Skills Challenge</b></a> and build expertise in implementing the configuration and coding tasks required to create and maintain the cloud and edge portions of an IoT solution.</b></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/svg/julyot.svg" alt="JulyOT Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/svg/julyot.svg" alt="JulyOT Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">#JulyOT</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/skills">Cloud Skills</a><a class="navbar__item navbar__link" href="/digitalswag">Digital Swag</a><a class="navbar__item navbar__link" href="/livestreams">Live Streams</a><a class="navbar__item navbar__link" href="/meetups">Meetups and Events</a><a class="navbar__item navbar__link" href="/resources">Resources</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Archives</a><ul class="dropdown__menu"><li><a href="https://techcommunity.microsoft.com/t5/internet-of-things-blog/julyot-2021-31-days-of-iot-content-for-everyone/ba-p/2427431?WT.mc_id=eventspg_16482_webpage_reactor" target="_blank" rel="noopener noreferrer" class="dropdown__link">#JulyOT 2021<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://techcommunity.microsoft.com/t5/internet-of-things-blog/julyot-a-month-of-learning-focused-on-azure-iot-solutions/ba-p/1497040?WT.mc_id=eventspg_16482_webpage_reactor" target="_blank" rel="noopener noreferrer" class="dropdown__link">#JulyOT 2020<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/JulyOT/JulyOT" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Most Recent Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/30-lgpc-handy">30: Let&#x27;s get personal: Computing - Open source prosthetics with Cliff Agius</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day29-az220">29: Exam AZ-220 Study Guide - Implement Security</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022-07-29-azure-percept-edge-ai">29: Discover how Azure Percept can deliver Edge AI solutions at scale in partnership with NVIDIA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/29-nano-framework">29: .NET nanoFramework Engineering Fundamentals</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day28-az220">28: Exam AZ-220 Study Guide - Monitor, Troubleshoot, and Optimize IoT Solutions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day27-az220">27: Exam AZ-220 Study Guide - Process and Manage Data</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/build-industrial-iot">27: Building Industrial IoT applications with the Microsoft Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day26-az220">26: Exam AZ-220 Study Guide - Implement Business Integration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/26-lgpc-altair">26: Let&#x27;s get personal: Computing - Retro computing with Dave Glover and the Altair 8800</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day25-az220">25: Exam AZ-220 Study Guide - Implement IoT Edge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/25-azure-percept-learn-modules">25: Azure Percept Learn Path</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day24-az220">24: Exam AZ-220 Study Guide - Provision and Manage Devices</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day23-az220">23: Exam AZ-220 Study Guide - Set up the IoT solution infrastructure</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/23-azure-cost-monitor">23: Azure cost monitor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/22-julyot-iot-beginners">22: IoT for Beginners lesson 4!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/22-nano-framework">22: Building .NET nanoFramework and interoperability</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day21-az220">21: Microsoft Certified - Azure IoT Developer Specialty</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/21-project-bonsai">21: Creating intelligent autonomous systems with project bonsai</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/20-azure-iot-pi-reterminal-juliot">20: Azure IoT con Raspberry Pi y reTerminal</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/20-azure-iot-pi-reterminal">20: Azure IoT with a Raspberry Pi and reTerminal</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day19-embedded">19: Powering Azure Sphere C Development with DevX</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/18-azure-percept-blog-posts">18: Unlimited possibilities with Azure Percept</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/16-iot-devices-for-prototyping">16: IoT Device Selection List for Prototyping</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/15-julyot-iot-beginners">15: IoT for Beginners lesson 3!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/15-nano-framework">15: .NET nanoFramework networking and Azure</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/14-iot-cow">14: AMA: IoT, cows, AI and poop - Jim discusses IoT in farming with Bryn Lewis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/13-iot-ama">13: Ask Me Anything at Reactor: Azure IoT!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day12-embedded">12: AI-powered predictive maintenance with Azure Sphere</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-cohetes-de-agua">11: Cohetes de agua - Water rockets!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-azure-percept-conference-sessions">11: Learn Azure Percept from conference sessions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/09-azure-circuit-python">09: Getting Started with Microsoft Azure and CircuitPython</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/08-julyot-iot-beginners">08: IoT for Beginners lesson 2!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/08-nano-framework">08: .NET nanoFramework GPIO, I2C, SPI and other IO support</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/07-closed-captioning-rpi">07: A Closed Captioning Example on Raspberry Pi using Azure Cognitive services</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/07-pnpflow">07: Plug and Play IoT device development with PnPFlow</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/06-edge-impulse-competition">06: Edge Impulse Project of the Month competition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day5-embedded">05: Altair Everywhere</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day4">04: Detect the very big with the very small – counting bears with TinyML meetup from IoT North</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-day2">02: IoT for beginners</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/01-nano-framework">01: Getting started with nanoFramework!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/01-julyot-kickoff">01: Welcome to #JulyOT!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/julyot-teaser">00: #JulyOT Is Coming!</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>12 posts tagged with &quot;embeddediot&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/22-nano-framework">22: Building .NET nanoFramework and interoperability</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-22T00:00:00.000Z" itemprop="datePublished">July 22, 2022</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ellerbach" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ellerbach.png" alt="Laurent Ellerbach"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ellerbach" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Laurent Ellerbach</span></a></div><small class="avatar__subtitle" itemprop="description">Principal Engineering Manager @Microsoft</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/josesimoes" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/josesimoes.png" alt="José Simões"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/josesimoes" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">José Simões</span></a></div><small class="avatar__subtitle" itemprop="description">CEO @Eclo Solutions</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p>Welcome to Day 22 of <strong>#JulyOT</strong>!</p></blockquote><p><img loading="lazy" alt="Page banner" src="/assets/images/JulyOT-banner-22-nanoframework-bb2c78ecc44f1843370749e24488b0e1.png" width="1000" height="420" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-net-nanoframework">Building .NET nanoFramework<a class="hash-link" href="#building-net-nanoframework" title="Direct link to heading">​</a></h2><p>You can build your image for an MCU with .NET nanoFramework. In most cases, you&#x27;ll use prebuilt images for popular boards, including advanced ESP32 devices like the ones from M5Stack for which we offer <a href="https://github.com/nanoframework/Home#m5stack" target="_blank" rel="noopener noreferrer">specific firmware</a> images and NuGets with <a href="https://github.com/nanoframework/nanoFramework.M5Stack" target="_blank" rel="noopener noreferrer">Board Support Packages</a>.</p><p>However, there are situations in which you&#x27;ll want to build the image yourself. There are Developer Container images available for you to use. They contain all the toolchains and required tools. Check out the article on <a href="https://docs.nanoframework.net/content/building/using-dev-container.html" target="_blank" rel="noopener noreferrer">using Dev Container to build targets</a>. In case you prefer not to use the Dev Containers, it&#x27;s possible to use a local setup too. Every step is well documented at <a href="https://docs.nanoframework.net/content/building/index.html" target="_blank" rel="noopener noreferrer">Building .NET nanoFramework</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="interop-in-net-nanoframework">Interop in .NET nanoFramework<a class="hash-link" href="#interop-in-net-nanoframework" title="Direct link to heading">​</a></h2><p>.NET nanoFramework supports a <em>lightweight</em> version of Interop which allows adding existing C/C++ code to .NET nanoFramework image. It&#x27;s convenient, for example,  when you want to use a library that has been perfected over the years or when there is the need to perform processor-intensive operations that benefit from being executed directly by the CPU.</p><p>This is architected in such a way that the &quot;foreign&quot; code remains completely isolated from the CLR and the official libraries and drivers. With this, you can&#x27;t break things upstream and it can be easily incorporated into the build process without requiring tweaks and handling complex merge operations.</p><p>Because the ultimate goal is to tap into this code from C#, there are two layers for this to happen:</p><ul><li>The C# library acts as a wrapper and offers the interface to the C/C++ code.</li><li>The C/C++ code that gets called from C#.</li></ul><p>Let&#x27;s take look at how this works by creating a very simple Interop library that reads a hardware ID and performs a &quot;complex&quot; calculation.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-c-managed-library">Creating the C# (managed) library<a class="hash-link" href="#creating-the-c-managed-library" title="Direct link to heading">​</a></h2><p>Create a new .NET nanoFramework project in Visual Studio</p><p>This is the very first step. Open Visual Studio, File, New Project.
Navigate to the C# .NET nanoFramework folder and select a Class Library project type.
For this example, we’ll call the project “NF.AwesomeLib”.</p><p><img loading="lazy" alt="New Class Library project" src="/assets/images/nanoframework-interop-new-project-e49a77bf8209768c03cb5ee4a40dfacf.png" width="941" height="653" class="img_ev3q"></p><p>Go to the Project properties (click the project icon in the Solution Explorer and go to the Properties Window) and navigate to the nanoFramework configuration properties view. Set the “Generate stub files” option to YES and the root name to NF.AwesomeLib.</p><p><img loading="lazy" alt="Class Library project properties" src="/assets/images/nanoframework-interop-library-properties-02d71fc87a2358b932b7b055157a7380.png" width="417" height="404" class="img_ev3q"></p><p>Now rename the Class1.cs that Visual Studio adds by default to Utilities.cs. Make sure that the class name inside that file gets renamed too. Add a new class named Math.cs. On both make sure that the class is public.</p><p>Your project should now look like this.</p><p><img loading="lazy" alt="Class Library project properties" src="/assets/images/nanoframework-interop-class-view-e72f720fd4f79aacb9661a3b29108dad.png" width="1086" height="696" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-the-api-methods-and-the-stubs">Adding the API methods and the stubs<a class="hash-link" href="#adding-the-api-methods-and-the-stubs" title="Direct link to heading">​</a></h3><p>The next step will be adding the methods and/or properties that you want available on the C# managed API. These are the ones that will be called from a C# project referencing your Interop library.</p><p>We&#x27;ll add an HardwareSerial property to the Utilities class and call the native method that supports the API at the native end. Like this.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace NF.AwesomeLib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public class Utilities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private static byte[] _hardwareSerial;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// Gets the hardware unique serial ID (12 bytes).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public static byte[] HardwareSerial</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (_hardwareSerial == null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    _hardwareSerial = new byte[12];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    NativeGetHardwareSerial(_hardwareSerial);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return _hardwareSerial;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #region Stubs </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [MethodImpl(MethodImplOptions.InternalCall)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private static extern void NativeGetHardwareSerial(byte[] data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #endregion stubs </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that, except for strings, you’re free to use any of the standard types in the arguments of the Interop methods. It’s OK to use arrays of those too.</p><p>A few explanations on the above:</p><ul><li>The property <code>HardwareSerial</code> has only a getter because we are only reading the serial from the hardware. As that can’t be written, it doesn’t make sense to provide a setter, right?</li><li>The serial number is stored in a backing field to be more efficient. When it’s read the first time it will go and read it from the processor. On subsequent accesses that won’t be necessary.</li><li>Note the summary comment on the property. Visual Studio uses that to generate an XML file that makes the awesome IntelliSense show that documentation on the projects referencing the library.</li><li>The serial number of the processor is handled as an array of bytes with a length of 12. This was taken from the device manual.</li><li>A stub method must exist to enable Visual Studio to create the placeholder for the C/C++ code. So you need to have one for each stub that is required.</li><li>The stub methods must be implemented as an extern and be decorated with the MethodImplAttribute attribute. Otherwise, Visual Studio won’t be able to do its magic.</li><li>You may want to find a working system for you regarding the stub naming and where you place them in the class. Maybe you want to group them in a region, or you prefer to keep them along the caller method. It will work in any of those ways, just a hint on keeping things organized.</li></ul><p>Moving on to the Math class. We’ll now add an API method called SuperComplicatedCalculation and the respective stub. It will look like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespace NF.AwesomeLib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public class Math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// Crunches value through a super complicated and secret calculation algorithm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// &lt;param name=&quot;value&quot;&gt;Value to crunch.&lt;/param&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// &lt;returns&gt;&lt;/returns&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public double SuperComplicatedCalculation(double value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return NativeSuperComplicatedCalculation(value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #region Stubs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [MethodImpl(MethodImplOptions.InternalCall)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private static extern double NativeSuperComplicatedCalculation(double value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #endregion stubs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And this is all that’s required on the managed side! Build the project and look at the project folder (using VS Code for example). This is what it will look like after a successful build:</p><p><img loading="lazy" alt="Class Library project properties" src="/assets/images/nanoframework-interop-native-view-db325e7e3707bbc84bfbc89873a5d759.png" width="1920" height="1040" class="img_ev3q"></p><p>From the top to the bottom, you can identify in the bin folder (debug or release flavor depending on your build preference) the .NET library that will be referenced in other projects. Please note that besides the .dll file there is the .xml file (the one that enables IntelliSense to do its magic), the .pdb file, and another one with a .pe extension.
When distributing the Interop library make sure that you package all four files. Failing to do so, will make Visual Studio complain that the project can’t build. You can distribute all those in a ZIP or even better, as a NuGet package.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="working-on-the-cc-native-code">Working on the C/C++ (native) code<a class="hash-link" href="#working-on-the-cc-native-code" title="Direct link to heading">​</a></h2><p>Moving to the Stubs folder we can find a bunch of files and a .cmake file. All those are required when building the nanoCLR image that will add support for your Interop library.</p><p>Look at the file names: they follow the namespace and class naming in the Visual Studio project.
Something very, very important: don’t rename or mess around with the content of those files. If you do that, you&#x27;ll risk that the image build will fail or you can also end up with the Interop library not doing anything. This can be very frustrating and hard to debug. So, again, DO NOT mess around with those files!</p><p>The only exception to that will be, of course, the ones that include the stubs for the C/C++ code that we&#x27;ll be adding. Those are the .cpp files that end with the class name.
In our example those are: <code>NF_AwesomeLib_NF_AwesomeLib_Math.cpp</code> and <code>NF_AwesomeLib_NF_AwesomeLib_Utilities.cpp</code>.</p><p>You’ve probably also noted that there are a couple of other files with a similar name but ending with _mshl. Those are the marshaling files that are responsible for validation, sanity checks, and marshaling the interface between the managed and native code. Those are to be left alone. Again DO NOT change them!</p><p>Let’s look at the stub file for the Utilities class. That’s the one that will read the processor serial number.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void Utilities::NativeGetHardwareSerial( CLR_RT_TypedArray_UINT8 param0, HRESULT &amp;hr )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is an empty C++ function named after the class and the stub method that you’ve placed in the C# project.</p><p>Let’s take a moment to understand what we have here.</p><ul><li>The return value of the C++ function matches the type of the C# stub method. Which is void in this case.</li><li>The first argument has a type that is mapping between the C# type and the equivalent C++ type. An array of bytes in this case.</li><li>The last argument is an HRESULT type whose purpose is to report the result of the code execution. We’ll get back to this so don’t worry about it for now. Just understand what’s the purpose of it.</li></ul><p>According to the programming manual STM32F4 devices have a 96 bits (12 bytes) unique serial number that is stored starting at address 0x1FFF7A10. For STM32F7 that address is 0x1FF0F420. In other STM32 series, the ID may be located at a different address. Now that we know where it is stored we can add code to read it. I’ll start with the code first and then walk through it.</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">Utilities</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">NativeGetHardwareSerial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> CLR_RT_TypedArray_UINT8 param0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HRESULT </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hr </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hr</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">CLR_E_BUFFER_TOO_SMALL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">param0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0x1FFF7A10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The first if statement is a sanity check to be sure that there is enough room in the array to hold the serial number bytes. Why is this important?
Remember that here we are not in the C# world anymore where the CRL and Visual Studio take care of the hard stuff for us. In C++ things are very different! In this particular example if the caller wouldn’t have reserved the required 12 bytes in memory to hold the complete serial array when writing onto it the 12 bytes from the serial could be overwriting something that is stored in the memory space ahead of the argument address. For types other than pointers such as bytes, integers, and doubles this check is not required.</p><p>Still on the if statement you can see that if there is not enough room we can’t continue. Before the code returns we are setting hr to CLR_E_BUFFER_TOO_SMALL (that’s the argument that holds the execution result, remember?). This is to signal that something went wrong and give some clue on what that might be. There is still more to say about this result argument, so we’ll get back to it.</p><p>The next piece of code is where – finally – we are reading the serial from the device.
As the serial number is accessible in a memory address we can simply use a <code>memcpy</code> to copy it from its memory location to the argument.
A few comments about the argument type (<code>CLR_RT_TypedArray_UINT8</code>). It acts like a wrapper for the memory block that holds the array (or a pointer if you prefer). The class for that type provides a function – called <code>GetBuffer()</code> – that returns the actual pointer that allows direct access to it. We need that because we have to pass a pointer when calling <code>memcpy</code>. This may sound a bit complicated, granted. If you are curious about the implementation details or want to know how it works I suggest that you delve into the .NET nanoFramework interpreter code in our <a href="https://github.com/nanoframework/nf-interpreter" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p><p>And that’s it! When this function returns the CPU serial number will be in the argument pointer and will eventually pop up in the C# managed code in that argument with the same name.</p><p>For the <code>Math</code> class, there won’t be any calls to hardware or any other fancy stuff, just a complicated and secret calculation to illustrate the use of Interop for simple code execution.</p><p>Visual Studio has already generated a nice stub for us to fill in with code. Here’s the original stub:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> </span><span class="token class-name">Math</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">NativeSuperComplicatedCalculation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> param0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HRESULT </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hr </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> retVal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> retVal</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that the stub function, again, matches the declaration of its C# managed counterpart and, again, has that <code>hr</code> argument to return the execution result.
Visual Studio was kind enough to add there the code for the return value so we can start coding on top of that. That is required, otherwise, this code wouldn’t even compile. 😉</p><p>Where is the super complicated and secret algorithm:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> </span><span class="token class-name">Math</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">NativeSuperComplicatedCalculation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> param0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HRESULT </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hr </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> retVal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retVal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> param0 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> retVal</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And, with this, we complete the native “low level” implementation of our Interop library.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-the-interop-library-to-a-nanoclr-image">Adding the Interop library to a nanoCLR image<a class="hash-link" href="#adding-the-interop-library-to-a-nanoclr-image" title="Direct link to heading">​</a></h2><p>The last step that is missing is adding the Interop source code files to the build of a nanoCLR image.</p><p>You can place the code files pretty much anywhere you want. Either on the same source tree or elsewhere. The nanoFramework interpreter repo has a folder named <code>Interop</code> that you can use for exactly this: holding the folders of the Interop assemblies that you have. Any changes inside that folder won’t be picked up by Git.
To make it simple we’ll follow that and we just copy what is in the Stubs folder into a new folder <code>InteropAssemblies\NF.AwesomeLib\</code>.</p><p>The next file to get our attention is <code>FindINTEROP-NF.AwesomeLib.cmake</code>. .NET nanoFramework uses CMake as its build system. Skipping through the technical details, suffice to say that, as far as CMake is concerned, the Interop assembly will be treated as a CMake module and, because of that, the file name for the file to be properly included in the build, has to named FindINTEROP-NF.AwesomeLib.cmake and has to be placed inside the CMake\Modules folder.</p><p>Inside that file, the only thing that requires your attention is the first statement where the location of the source code folder is declared.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># native code directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(BASE_PATH_FOR_THIS_MODULE &quot;${BASE_PATH_FOR_CLASS_LIBRARIES_MODULES}/NF.AwesomeLib&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(...)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you are placing it inside that <code>Interop</code> folder the required changes are:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># native code directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(BASE_PATH_FOR_THIS_MODULE &quot;${PROJECT_SOURCE_DIR}/InteropAssemblies/NF.AwesomeLib&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(...)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And this is it! Now to the build.</p><p>Please refer to the documentation mentioned above about using Dev Containers or setting up the local toolchain to build .NET nanoFramework firmware image.</p><p>Let&#x27;s assume If you are using the CMake Tools module to build inside VS Code. You need to declare that you want this Interop assembly added to the build. Do so by opening the CMakeUserPresets.json file and navigating to the settings for the target you want it added to.</p><p>There you need to add the following CMake build option:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;cacheVariables&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;TARGET_BOARD&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;STRING&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;value&quot;: &quot;${presetName}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;NF_INTEROP_ASSEMBLIES&quot;: [ &quot;NF.AwesomeLib&quot; ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A couple of notes about this:</p><p>The <code>NF_INTEROP_ASSEMBLIES</code> option expects a collection. This is because you can add as many Interop libraries as you want to a nanoCLR firmware image.
The name of the assembly must match exactly the class name. Dots included. If you screw up this you’ll notice it immediately in the build.</p><p>The following task is launching the image build. Fingers crossed you won&#x27;t have any errors… 😉</p><p>First, check the CMake preparation output, you should see the Interop library listed:</p><p><img loading="lazy" alt="CMake build setup" src="/assets/images/nanoframework-interop-build-include-lib-f1370c1090f9dc416296231f4d08a707.png" width="397" height="157" class="img_ev3q"></p><p>After the build completes successfully, you should be seeing something similar to this:</p><p><img loading="lazy" alt="CMake build setup" src="/assets/images/nanoframework-interop-build-ok-418acd5fa9282669f1abd4c17536a925.png" width="775" height="104" class="img_ev3q"></p><p>We now have a nanoCLR firmware image ready to be flashed on a real board!</p><p>The next check after loading a target with the nanoCLR firmware image that includes the Interop library is seeing it listed in the Native Assemblies listing. After booting the target is listed in the Visual Studio Device Explorer list and after you click on the Device Capabilities button you’ll see it in the output window like this:</p><p><img loading="lazy" alt="CMake build setup" src="/assets/images/nanoframework-interop-device-capabilities-302f0fac7310017249822f6f4c0a3dc4.png" width="546" height="242" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-an-interop-library">Using an Interop library<a class="hash-link" href="#using-an-interop-library" title="Direct link to heading">​</a></h2><p>This works just like any other .NET library that you use every day. In Visual Studio open the Add reference dialog and search for the NF.AwesomeLib.dll file that was the output result of building the Interop Project (you’ll find it in the bin folder). As you are going through that, note the companion XML file with the same name. With that file there you’ll see the documentation comments shown by IntelliSense as you code.</p><p>This is the code to test the Interop library. In the first part, we read the CPU serial number and output it as a hexadecimal formatted string. On the second we call the method that crunches the input value.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static void Main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // testing cpu serial number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string serialNumber = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach (byte b in Utilities.HardwareSerial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        serialNumber += b.ToString(&quot;X2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Debug.WriteLine(&quot;cpu serial number: &quot; + serialNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // test complicated calculation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NF.AwesomeLib.Math math = new NF.AwesomeLib.Math();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    double result = math.SuperComplicatedCalculation(11.12);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Debug.WriteLine(&quot;calculation result: &quot; + result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.Sleep(Timeout.Infinite);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here’s a screenshot of Visual Studio running the test app. Note the serial number and the calculation result in the Output window (in green). Also, the DLL is listed in the project references (in yellow).</p><p><img loading="lazy" alt="CMake build setup" src="/assets/images/nanoframework-interop-referencing-library-2296cacb8bc168a23f4199bc0d26740c.png" width="1373" height="962" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping-up">Wrapping up<a class="hash-link" href="#wrapping-up" title="Direct link to heading">​</a></h2><p>And that’s it! We&#x27;ve seen how powerful this Interop feature is and hopefully illustrated how you can (re)use C/C++ code in a .NET nanoFramework C# application!</p><p>The content above describes the key aspects and steps to get Interop working. It is a complex feature and you can read a more thorough and detailed description of all this in <a href="https://jsimoesblog.wordpress.com/2018/06/19/interop-in-net-nanoframework/" target="_blank" rel="noopener noreferrer">this blog post</a>.</p><p>Also, you can find the code related to Interop in .NET nanoFramework in our <a href="https://github.com/nanoframework/Samples/tree/main/samples/Interop" target="_blank" rel="noopener noreferrer">samples repository</a>.</p><p>Enjoy it and have fun coding with .NET C# for microcontrollers!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/30-days">30days</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/iot">iot</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/embeddediot">embeddediot</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tags/embeddediot/page/2"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tags/embeddediot/page/4"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Microsoft - Built by @AzureAdvocates using @Docusaurus ♥️</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a74aaf32.js"></script>
<script src="/assets/js/main.e393e4c5.js"></script>
</body>
</html>